package com.revature.delegates;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.revature.data.AccountPostGres;
import com.revature.data.RolePostGres;
import com.revature.data.UserPostGres;
import com.revature.humans.User;
import com.revature.services.UserService;

/*
 * ENDPOINTS
 *	/users GET - ONLY EMPLOYEE OR ADMIN  return all users?
 *			POST - ADMIN OR ONLY IF id matches, updates user
 *
 *	/users/:id
 *		GET - ONLY ADMIN OR EMPLOYEE, return user
 *
 */
public class UserDelegate implements FrontControllerDelegate{
	
	private UserService uServ = new UserService(new UserPostGres(), new RolePostGres(), new AccountPostGres());
	
	private ObjectMapper om = new ObjectMapper();
	
	@Override
	public void process(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		String path = (String) req.getAttribute("path");
		
		if( path == null || path.equals("")) {
			switch(req.getMethod()) {
				case("POST"):
					User updateUser = (User) om.readValue(req.getInputStream(), User.class);
					User currentUser = (User) req.getSession().getAttribute("user");
					
					if(currentUser.getRole().getRole().equals("Admin") ||
						updateUser.getId() == currentUser.getId()) {
						uServ.updateEmail(currentUser, updateUser.getEmail());
						uServ.updatePassword(currentUser, updateUser.getPassword());
						resp.getWriter().write(om.writeValueAsString(updateUser));
					}
					else {
						resp.sendError(401, "The request action is not permitted");
					}
					break;
				case("GET"):
					// ??
					break;
				default:
					resp.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED);
					break;
			}
		}
		else {
			User currentUser = (User) req.getSession().getAttribute("user");
			if(currentUser.getRole().getRole().equals("Admin") ||
				currentUser.getRole().getRole().equals("Employee")) {
					
				int userId = Integer.valueOf(path);
				User foundUser = null;
				
				switch(req.getMethod()) {
					case("GET"):
						foundUser = uServ.findUserbyID(userId);
						if(foundUser != null){
							resp.getWriter().write(om.writeValueAsString(foundUser));
						}
						else {
							resp.sendError(HttpServletResponse.SC_NOT_FOUND);
						}
						break;
					default:
						resp.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED);
						break;
					}
				}
			else {
				resp.sendError(401, "The request action is not permitted");
				}
			}
		
		}

}
